name: Generate STL and PNG from SCAD files

on:
  push:
    paths:
      - '**/*.scad'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install OpenSCAD
        run: |
          sudo apt-get update
          sudo apt-get install -y openscad xvfb
          openscad --version

      - name: Generate STL and PNG files
        run: |
          find . -name "*.scad" -not -path "./.git/*" | while read -r scad_file; do
            echo "Processing: $scad_file"

            dir=$(dirname "$scad_file")
            base=$(basename "$scad_file" .scad)
            stl_file="$dir/$base.stl"
            png_file="$dir/$base.png"

            echo "  Generating STL: $stl_file"
            if openscad -o "$stl_file" "$scad_file" 2>&1 | grep -v "^$"; then
              if [ -f "$stl_file" ]; then
                echo "  ✓ STL generated successfully ($(du -h "$stl_file" | cut -f1))"
              else
                echo "  ✗ Failed to generate STL"
                exit 1
              fi
            fi

            echo "  Generating PNG: $png_file"
            if xvfb-run -a openscad -o "$png_file" \
              --imgsize=1024,768 \
              --view=axes,scales \
              --projection=ortho \
              --colorscheme=Tomorrow \
              --camera=0,0,0,60,0,25,500 \
              "$scad_file" 2>&1 | grep -v "^$"; then
              if [ -f "$png_file" ]; then
                echo "  ✓ PNG generated successfully ($(du -h "$png_file" | cut -f1))"
              else
                echo "  ✗ Failed to generate PNG"
                exit 1
              fi
            fi

            echo ""
          done

      - name: Check for changes
        id: check-changes
        run: |
          # Add generated files to staging area first
          git add -- *.stl *.png 2>/dev/null || true
          git add -- */*.stl */*.png 2>/dev/null || true

          # Check if there are staged changes (includes new files)
          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            git diff --cached --name-only
          fi

      - name: Commit and push generated files
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Files to be committed:"
          git diff --cached --name-only

          changed_files=$(git diff --cached --name-only | tr '\n' ', ' | sed 's/,$//')

          printf "%s\n\n%s\n\n%s" \
            "Auto-generate STL and PNG files from SCAD sources" \
            "Generated files: $changed_files" \
            "[skip ci]" > /tmp/commit-msg

          git commit -F /tmp/commit-msg

          echo "Pushing changes to $REF_NAME..."
          git push origin "HEAD:$REF_NAME"
