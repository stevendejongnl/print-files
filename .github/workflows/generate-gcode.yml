name: Generate G-code from STL files

on:
  push:
    paths:
      - '**/*.stl'
      - 'profiles/*.cfg'
      - 'profiles/*.curaprofile'
  workflow_dispatch:
    inputs:
      profile:
        description: 'Filament profile to use'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - pla-plus
          - petg
          - petg-cf

permissions:
  contents: write

jobs:
  generate-gcode:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install CuraEngine
        run: |
          sudo apt-get update
          sudo apt-get install -y cura-engine
          CuraEngine help 2>&1 | head -5 || echo "CuraEngine installed"

      - name: Download printer definitions
        id: find-definition
        run: |
          # CuraEngine 4.13 (Ubuntu 22.04) needs Cura 4.13 definitions
          # The cura-engine package only provides the binary, not definitions
          DEFS_DIR="/tmp/cura-definitions"
          mkdir -p "$DEFS_DIR"

          # Check for custom definition in repo first
          if [ -f "profiles/printer.def.json" ]; then
            cp profiles/printer.def.json "$DEFS_DIR/"
            echo "Using custom printer definition from profiles/"
          else
            # Download version-matched definitions from Cura 4.13
            echo "Downloading Cura 4.13 printer definitions..."
            curl -sfL "https://raw.githubusercontent.com/Ultimaker/Cura/4.13/resources/definitions/fdmprinter.def.json" \
              -o "$DEFS_DIR/fdmprinter.def.json"
            curl -sfL "https://raw.githubusercontent.com/Ultimaker/Cura/4.13/resources/definitions/fdmextruder.def.json" \
              -o "$DEFS_DIR/fdmextruder.def.json"
            echo "Downloaded fdmprinter.def.json and fdmextruder.def.json"
          fi

          echo "definition=$DEFS_DIR/fdmprinter.def.json" >> "$GITHUB_OUTPUT"
          echo "search_path=$DEFS_DIR" >> "$GITHUB_OUTPUT"
          ls -lh "$DEFS_DIR/"

      - name: Determine profiles
        id: profiles
        env:
          PROFILE_INPUT: ${{ github.event.inputs.profile }}
        run: |
          SELECTION="${PROFILE_INPUT:-all}"
          if [ "$SELECTION" = "all" ]; then
            # Collect all .cfg profile names
            PROFILES=""
            for cfg in profiles/*.cfg; do
              name=$(basename "$cfg" .cfg)
              PROFILES="${PROFILES:+$PROFILES }$name"
            done
          else
            PROFILES="$SELECTION"
          fi
          echo "list=$PROFILES" >> "$GITHUB_OUTPUT"
          echo "Profiles to generate: $PROFILES"

      - name: Generate G-code files
        env:
          PROFILES: ${{ steps.profiles.outputs.list }}
          DEFINITION: ${{ steps.find-definition.outputs.definition }}
          CURA_ENGINE_SEARCH_PATH: ${{ steps.find-definition.outputs.search_path }}
        run: |
          TOTAL_GENERATED=0
          TOTAL_FAILED=0

          for PROFILE in $PROFILES; do
            echo "========================================"
            echo "Profile: $PROFILE"
            echo "========================================"

            PROFILE_FILE="profiles/${PROFILE}.cfg"

            if [ ! -f "$PROFILE_FILE" ]; then
              echo "Warning: Profile not found: $PROFILE_FILE, skipping"
              continue
            fi

            echo "Definition: $DEFINITION"
            echo "Search path: $CURA_ENGINE_SEARCH_PATH"
            echo ""

            # Build settings arguments array from profile
            SETTINGS_ARGS=()
            while IFS= read -r line; do
              # Remove comments and trim whitespace
              line="${line%%#*}"
              line="$(echo "$line" | xargs)"
              if [ -z "$line" ]; then
                continue
              fi
              if [[ "$line" =~ ^([a-zA-Z_][a-zA-Z0-9_]*)\ *=\ *(.+)$ ]]; then
                key="${BASH_REMATCH[1]}"
                value="$(echo "${BASH_REMATCH[2]}" | xargs)"
                SETTINGS_ARGS+=("-s" "${key}=${value}")
              fi
            done < "$PROFILE_FILE"

            echo "Loaded ${#SETTINGS_ARGS[@]} setting arguments"
            echo ""

            # Find and process all STL files
            while IFS= read -r stl_file; do
              echo "Processing: $stl_file"

              dir=$(dirname "$stl_file")
              base=$(basename "$stl_file" .stl)
              gcode_file="$dir/$base.$PROFILE.gcode"

              echo "  Generating G-code: $gcode_file"

              if CuraEngine slice \
                -j "$DEFINITION" \
                "${SETTINGS_ARGS[@]}" \
                -l "$stl_file" \
                -o "$gcode_file" 2>&1; then
                if [ -f "$gcode_file" ] && [ -s "$gcode_file" ]; then
                  echo "  Generated successfully ($(du -h "$gcode_file" | cut -f1))"
                  TOTAL_GENERATED=$((TOTAL_GENERATED + 1))
                else
                  echo "  Warning: G-code file empty or missing"
                  rm -f "$gcode_file"
                  TOTAL_FAILED=$((TOTAL_FAILED + 1))
                fi
              else
                echo "  Error: CuraEngine failed for $stl_file"
                rm -f "$gcode_file"
                TOTAL_FAILED=$((TOTAL_FAILED + 1))
              fi

              echo ""
            done < <(find . -name "*.stl" -not -path "./.git/*" -not -path "./docs/*" | sort)

          done

          echo "========================================"
          echo "Summary: $TOTAL_GENERATED generated, $TOTAL_FAILED failed"
          echo "========================================"
          if [ "$TOTAL_GENERATED" -eq 0 ] && [ "$TOTAL_FAILED" -gt 0 ]; then
            echo "Error: All STL files failed to generate G-code"
            exit 1
          fi

      - name: Check for changes
        id: check-changes
        run: |
          # Add all generated G-code files using find for reliable matching
          find . -name '*.gcode' -not -path './.git/*' -not -path './docs/*' \
            -exec git add {} +

          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No G-code changes detected"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "G-code changes detected:"
            git diff --cached --name-only
          fi

      - name: Commit and push generated files
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          PROFILES: ${{ steps.profiles.outputs.list }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Files to be committed:"
          git diff --cached --name-only

          changed_files=$(git diff --cached --name-only | tr '\n' ', ' | sed 's/,$//')

          printf "%s\n\n%s\n%s\n\n%s" \
            "Auto-generate G-code from STL files" \
            "Profiles: $PROFILES" \
            "Generated files: $changed_files" \
            "[skip ci]" > /tmp/commit-msg

          git commit -F /tmp/commit-msg

          echo "Pushing changes to $REF_NAME..."
          git push origin "HEAD:$REF_NAME"
