name: Sync Web Gallery

on:
  push:
    paths:
      - '**/*.stl'
      - '**/*.png'
      - '**/*.scad'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-gallery:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync project files to docs/projects/
        run: |
          echo "Syncing project files to docs/projects/..."

          # Remove old projects folder and recreate
          rm -rf docs/projects
          mkdir -p docs/projects

          # Find all project directories (directories containing .stl, .scad, or .png files)
          # Use process substitution to avoid subshell issues
          while IFS= read -r project_dir; do
            project_name=$(basename "$project_dir")

            # Skip docs and .git directories
            if [[ "$project_dir" == "./docs" ]] || [[ "$project_dir" == "./.git"* ]]; then
              continue
            fi

            # Skip root directory
            if [ "$project_dir" = "." ]; then
              continue
            fi

            # Create project directory in docs
            mkdir -p "docs/projects/$project_name"

            # Copy all relevant files
            find "$project_dir" -maxdepth 1 -type f \( -name "*.stl" -o -name "*.png" -o -name "*.scad" \) -exec cp {} "docs/projects/$project_name/" \;

            echo "  ✓ Synced: $project_name"
          done < <(find . -maxdepth 1 -type d -not -path "." -not -path "./docs" -not -path "./.git*")

      - name: Generate projects.json
        run: |
          echo "Generating projects.json..."

          # Create temporary file for JSON entries
          temp_json=$(mktemp)

          # Find all project directories in docs/projects and generate JSON
          first=true
          while IFS= read -r project_dir; do
            project_name=$(basename "$project_dir")

            # Find files in this project
            stl_file=$(find "$project_dir" -maxdepth 1 -name "*.stl" | head -n 1)
            png_file=$(find "$project_dir" -maxdepth 1 -name "*.png" | head -n 1)
            scad_file=$(find "$project_dir" -maxdepth 1 -name "*.scad" | head -n 1)

            # Skip if no files found
            if [ -z "$stl_file" ] && [ -z "$scad_file" ]; then
              continue
            fi

            # Convert absolute paths to relative paths from docs/
            stl_rel=""
            png_rel=""
            scad_rel=""
            if [ -n "$stl_file" ]; then
              stl_rel=$(echo "$stl_file" | sed 's|docs/||')
            fi
            if [ -n "$png_file" ]; then
              png_rel=$(echo "$png_file" | sed 's|docs/||')
            fi
            if [ -n "$scad_file" ]; then
              scad_rel=$(echo "$scad_file" | sed 's|docs/||')
            fi

            # Add comma if not first entry
            if [ "$first" = false ]; then
              echo "," >> "$temp_json"
            fi
            first=false

            # Generate JSON entry
            cat >> "$temp_json" <<EOF
  {
    "name": "$project_name",
    "description": "3D printable design",
    "stl": ${stl_rel:+\"$stl_rel\"}${stl_rel:-null},
    "preview": ${png_rel:+\"$png_rel\"}${png_rel:-null},
    "scad": ${scad_rel:+\"$scad_rel\"}${scad_rel:-null},
    "isPublic": true,
    "category": "3D Prints"
  }
EOF
          done < <(find docs/projects -mindepth 1 -maxdepth 1 -type d | sort)

          # Build final JSON file
          echo "[" > docs/projects.json
          cat "$temp_json" >> docs/projects.json
          echo "" >> docs/projects.json
          echo "]" >> docs/projects.json

          # Clean up
          rm "$temp_json"

          echo "✓ projects.json generated"
          echo ""
          echo "Generated content:"
          cat docs/projects.json

      - name: Check for changes
        id: check-changes
        run: |
          git add docs/

          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to gallery"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Gallery changes detected:"
            git diff --cached --name-status
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "Auto-sync web gallery

          - Sync project files to docs/projects/
          - Auto-generate projects.json

          [skip ci]"

          git push origin HEAD:${{ github.ref_name }}
