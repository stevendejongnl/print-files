name: Sync Web Gallery

on:
  push:
    paths:
      - '**/*.stl'
      - '**/*.png'
      - '**/*.scad'
      - '**/*.gcode'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-gallery:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync project files to docs/projects/
        run: |
          echo "Syncing project files to docs/projects/..."

          # Remove old projects folder and recreate
          rm -rf docs/projects
          mkdir -p docs/projects

          # Enable nullglob to handle empty directory case
          shopt -s nullglob

          # Find all project directories (maxdepth 1, skip docs and .git)
          for project_dir in */; do
            # Remove trailing slash
            project_dir="${project_dir%/}"

            # Skip docs and .git directories
            if [ "$project_dir" = "docs" ] || [ "$project_dir" = ".git" ]; then
              continue
            fi

            # Check if directory contains any 3D files
            has_files=false
            for ext in stl png scad gcode; do
              if compgen -G "$project_dir/*.$ext" > /dev/null; then
                has_files=true
                break
              fi
            done

            if [ "$has_files" = true ]; then
              # Create project directory in docs
              mkdir -p "docs/projects/$project_dir"

              # Copy all relevant files
              cp "$project_dir"/*.stl "docs/projects/$project_dir/" 2>/dev/null || true
              cp "$project_dir"/*.png "docs/projects/$project_dir/" 2>/dev/null || true
              cp "$project_dir"/*.scad "docs/projects/$project_dir/" 2>/dev/null || true
              cp "$project_dir"/*.gcode "docs/projects/$project_dir/" 2>/dev/null || true

              echo "  ✓ Synced: $project_dir"
            fi
          done

      - name: Generate projects.json
        run: |
          python3 << 'EOF'
          import json
          import os
          from pathlib import Path

          projects = []
          projects_dir = Path("docs/projects")

          if projects_dir.exists():
              for project_path in sorted(projects_dir.iterdir()):
                  if not project_path.is_dir():
                      continue

                  project_name = project_path.name

                  # Find files
                  stl_files = list(project_path.glob("*.stl"))
                  png_files = list(project_path.glob("*.png"))
                  scad_files = list(project_path.glob("*.scad"))
                  gcode_files = sorted(project_path.glob("*.gcode"))

                  # Skip if no STL or SCAD
                  if not stl_files and not scad_files:
                      continue

                  # Build G-code entries list
                  gcode_list = [
                      f"projects/{project_name}/{g.name}" for g in gcode_files
                  ]

                  # Build project entry
                  project = {
                      "name": project_name,
                      "description": "3D printable design",
                      "stl": f"projects/{project_name}/{stl_files[0].name}" if stl_files else None,
                      "preview": f"projects/{project_name}/{png_files[0].name}" if png_files else None,
                      "scad": f"projects/{project_name}/{scad_files[0].name}" if scad_files else None,
                      "gcode": gcode_list if gcode_list else None,
                      "isPublic": True,
                      "category": "3D Prints"
                  }
                  projects.append(project)

          # Write JSON file
          with open("docs/projects.json", "w") as f:
              json.dump(projects, f, indent=2)

          print("✓ projects.json generated")
          print("\nGenerated content:")
          print(json.dumps(projects, indent=2))
          EOF

      - name: Check for changes
        id: check-changes
        run: |
          git add docs/

          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No changes to gallery"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Gallery changes detected:"
            git diff --cached --name-status
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "Auto-sync web gallery

          - Sync project files to docs/projects/
          - Auto-generate projects.json

          [skip ci]"

          git push origin HEAD:${{ github.ref_name }}
