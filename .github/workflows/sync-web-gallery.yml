name: Sync Web Gallery

on:
  push:
    paths:
      - '**/*.stl'
      - '**/*.png'
      - '**/*.scad'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-gallery:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync project files to docs/projects/
        run: |
          echo "Syncing project files to docs/projects/..."

          # Remove old projects folder and recreate
          rm -rf docs/projects
          mkdir -p docs/projects

          # Find all project directories (maxdepth 1, skip docs and .git)
          for project_dir in */; do
            # Remove trailing slash
            project_dir="${project_dir%/}"

            # Skip docs and .git directories
            if [ "$project_dir" = "docs" ] || [ "$project_dir" = ".git" ]; then
              continue
            fi

            # Check if directory contains any 3D files
            has_files=false
            for ext in stl png scad; do
              if compgen -G "$project_dir/*.$ext" > /dev/null; then
                has_files=true
                break
              fi
            done

            if [ "$has_files" = true ]; then
              # Create project directory in docs
              mkdir -p "docs/projects/$project_dir"

              # Copy all relevant files
              cp "$project_dir"/*.stl "docs/projects/$project_dir/" 2>/dev/null || true
              cp "$project_dir"/*.png "docs/projects/$project_dir/" 2>/dev/null || true
              cp "$project_dir"/*.scad "docs/projects/$project_dir/" 2>/dev/null || true

              echo "  ✓ Synced: $project_dir"
            fi
          done

      - name: Generate projects.json
        run: |
          echo "Generating projects.json..."

          # Start building JSON
          echo "[" > docs/projects.json

          first=true

          # Loop through project directories
          for project_dir in docs/projects/*/; do
            # Skip if no directories found
            [ -d "$project_dir" ] || continue

            # Remove trailing slash and get project name
            project_dir="${project_dir%/}"
            project_name=$(basename "$project_dir")

            # Find files in this project
            stl_file=$(find "$project_dir" -maxdepth 1 -name "*.stl" -print -quit)
            png_file=$(find "$project_dir" -maxdepth 1 -name "*.png" -print -quit)
            scad_file=$(find "$project_dir" -maxdepth 1 -name "*.scad" -print -quit)

            # Skip if no STL or SCAD found
            if [ -z "$stl_file" ] && [ -z "$scad_file" ]; then
              continue
            fi

            # Convert to relative paths
            stl_rel=""
            png_rel=""
            scad_rel=""

            if [ -n "$stl_file" ]; then
              stl_rel="${stl_file#docs/}"
            fi
            if [ -n "$png_file" ]; then
              png_rel="${png_file#docs/}"
            fi
            if [ -n "$scad_file" ]; then
              scad_rel="${scad_file#docs/}"
            fi

            # Add comma if not first entry
            if [ "$first" = false ]; then
              echo "," >> docs/projects.json
            fi
            first=false

            # Generate JSON entry
            echo "  {" >> docs/projects.json
            echo "    \"name\": \"$project_name\"," >> docs/projects.json
            echo "    \"description\": \"3D printable design\"," >> docs/projects.json
            echo "    \"stl\": ${stl_rel:+\"$stl_rel\"}${stl_rel:-null}," >> docs/projects.json
            echo "    \"preview\": ${png_rel:+\"$png_rel\"}${png_rel:-null}," >> docs/projects.json
            echo "    \"scad\": ${scad_rel:+\"$scad_rel\"}${scad_rel:-null}," >> docs/projects.json
            echo "    \"isPublic\": true," >> docs/projects.json
            echo "    \"category\": \"3D Prints\"" >> docs/projects.json
            echo "  }" >> docs/projects.json
          done

          # Close JSON array
          echo "" >> docs/projects.json
          echo "]" >> docs/projects.json

          echo "✓ projects.json generated"
          echo ""
          echo "Generated content:"
          cat docs/projects.json

      - name: Check for changes
        id: check-changes
        run: |
          git add docs/

          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to gallery"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Gallery changes detected:"
            git diff --cached --name-status
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "Auto-sync web gallery

          - Sync project files to docs/projects/
          - Auto-generate projects.json

          [skip ci]"

          git push origin HEAD:${{ github.ref_name }}
